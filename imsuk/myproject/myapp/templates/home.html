{% extends 'base.html' %}
{% load static %}
{% block title %}‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å - IMSUK{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto p-6">
  <h1 class="text-4xl font-extrabold text-custom-darkgreen mb-8 text-center">üç± ‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h1>

  <!-- ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ -->
  <form method="get" action="{% url 'home' %}" class="mb-10">
    <div class="flex items-center">
      <div class="relative flex-grow">
        <input type="text" name="q" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£..." value="{{ request.GET.q }}"
               class="w-full pl-12 pr-4 py-3 border border-custom-green rounded-l-xl shadow-md focus:outline-none focus:ring-2 focus:ring-custom-darkgreen transition">
        <span class="absolute inset-y-0 left-0 flex items-center pl-4 text-custom-darkgreen text-xl">üîç</span>
      </div>
      <button type="submit"
              class="bg-custom-darkgreen text-white px-6 py-3 rounded-r-xl hover:bg-custom-darkgreen-hover transition duration-300 font-semibold">
        ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
      </button>
    </div>
  </form>

  <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
    {% for item in menu_items %}
      <div class="bg-custom-lightpink rounded-2xl shadow-md p-4 hover:shadow-xl transition duration-300 relative">
        {% if item.image %}
          <img src="{{ item.image.url }}" alt="{{ item.name }}" class="w-full h-48 object-cover rounded-xl mb-3">
        {% else %}
          <div class="w-full h-48 bg-gray-200 flex items-center justify-center text-gray-500 rounded-xl mb-3">
            ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
          </div>
        {% endif %}

        <!-- ‚ù§Ô∏è ‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏£‡πâ‡∏≤‡∏ô‡πÇ‡∏õ‡∏£‡∏î -->
        <a href="{% url 'add_favorite' item.restaurant.id %}"
           class="absolute top-3 right-3 bg-white rounded-full p-2 shadow hover:scale-110 transition">
          <span class="text-red-500 text-xl">‚ù§Ô∏è</span>
        </a>

        <h2 class="text-xl font-bold text-custom-darkgreen mb-1">{{ item.name }}</h2>
        <p class="text-sm italic text-gray-600 mb-2">‡∏à‡∏≤‡∏Å‡∏£‡πâ‡∏≤‡∏ô <span class="text-custom-brown font-medium">{{ item.restaurant.name }}</span></p>

        <p class="text-custom-darkgreen font-semibold text-lg mb-2">‡∏ø{{ item.sale_price }}</p>

        <p class="text-sm text-gray-600 flex items-center mb-2">
          <span class="text-xl mr-1">‚è∞</span>
          {{ item.restaurant.open_time|time:'H:i' }} - {{ item.restaurant.close_time|time:'H:i' }}
        </p>

        <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î -->
        <a href="{% url 'menu_detail' item.id %}"
           class="inline-block text-white bg-custom-pink px-4 py-2 rounded-xl font-medium shadow hover:bg-pink-500 transition mb-4">
          üìã ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
        </a>

        {% if user.is_authenticated %}
        <form method="post" action="{% url 'add_to_cart' item.id %}" class="quantity-form mt-2">
          {% csrf_token %}
          <div class="flex items-center justify-between space-x-4">
            <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏î -->
            <div class="flex items-center space-x-3 border border-gray-300 rounded-full px-4 py-2 shadow bg-white">
              <button type="button"
                      onclick="changeQty({{ item.id }}, -1);"
                      class="bg-red-400 text-white w-8 h-8 rounded-full flex justify-center items-center text-lg font-bold"
                      id="btn-decrease-{{ item.id }}">‚àí</button>

              <span id="qty-{{ item.id }}" class="text-lg font-semibold w-8 text-center">0</span>
              <input type="hidden" name="quantity" id="input-qty-{{ item.id }}" value="0">

              <button type="button"
                      onclick="changeQty({{ item.id }}, 1);"
                      class="bg-green-500 text-white w-8 h-8 rounded-full flex justify-center items-center text-lg font-bold">+</button>
            </div>

            <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô -->
            <button type="submit"
                    class="bg-custom-darkgreen text-white px-4 py-2 rounded-xl shadow font-semibold disabled:opacity-50 transition"
                    id="confirm-btn-{{ item.id }}" disabled>
              ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
            </button>
          </div>
        </form>
        {% else %}
          <p class="text-sm text-center text-gray-500 mt-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ <a href="{% url 'login' %}" class="text-blue-600 underline">‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô</a> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£</p>
        {% endif %}
      </div>
    {% empty %}
      <p class="text-xl text-gray-600 col-span-full text-center py-6">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</p>
    {% endfor %}
  </div>
</div>

<!-- ‚úÖ JavaScript ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô -->
<script>
function changeQty(itemId, change) {
  const qtySpan = document.getElementById(`qty-${itemId}`);
  const qtyInput = document.getElementById(`input-qty-${itemId}`);
  const confirmBtn = document.getElementById(`confirm-btn-${itemId}`);
  const decreaseBtn = document.getElementById(`btn-decrease-${itemId}`);

  let current = parseInt(qtySpan.textContent);
  let newQty = current + change;

  if (newQty < 0) newQty = 0;

  qtySpan.textContent = newQty;
  qtyInput.value = newQty;

  confirmBtn.disabled = newQty === 0;
  decreaseBtn.disabled = newQty === 0;
}
</script>
{% endblock %}
